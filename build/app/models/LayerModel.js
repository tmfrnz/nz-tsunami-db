define(["jquery","underscore","backbone","leaflet","esri.leaflet"],function(t,e,i,s,a){return i.Model.extend({initialize:function(t){this.options=t||{},this.isContentLoading=!1,this.isContentLoaded=!1,this.id=this.attributes.id,this.setBasemap(void 0!==this.attributes.basemap&&this.attributes.basemap),this.set("selected",!0),this.initializeModel()},initializeModel:function(){},loadData:function(){},setData:function(t){this.set("mapLayer",t),this.handleResult()},getMapLayerDirect:function(){if(this.isLoaded())return this.attributes.mapLayer},getMapLayer:function(t){if(this.isLoaded())void 0!==t&&t(this.attributes.mapLayer);else{var e=this;this.attributes.loading?waitFor(function(){return e.isLoaded()},function(){void 0!==t&&t(e.attributes.mapLayer)}):this.loadData(function(i){e.set("mapLayer",i),e.handleResult(t)})}},handleResult:function(t){this.attributes.mapLayer.options.layerModel=this,this.initInteractions(),void 0!==t&&t(this.attributes.mapLayer)},initInteractions:function(){"point"!==this.attributes.type&&"triangle"!==this.attributes.type||this.attributes.mapLayer.off("mousedown").on("mousedown",e.bind(this.pointLayerClick,this)).off("mousemove").on("mousemove",e.bind(this.pointLayerMouseOver,this)).off("mouseout").on("mouseout",e.bind(this.pointLayerMouseOut,this))},pointLayerClick:function(t){if(void 0!==this.attributes.eventContext){var e=this.attributes.mapLayer._map.layerPointToContainerPoint(t.layerPoint);this.attributes.eventContext.trigger("pointLayerClick",{id:this.id,latlng:t.latlng,x:e.x,y:e.y,event:t})}},pointLayerMouseOver:function(t){if(void 0!==this.attributes.eventContext&&(!this.get("anySelected")||this.get("selected"))){var e=this.attributes.mapLayer._map.layerPointToContainerPoint(t.layerPoint);this.attributes.eventContext.trigger("pointLayerMouseOver",{id:this.id,latlng:t.latlng,x:e.x,y:e.y,event:t})}},pointLayerMouseOut:function(t){void 0!==this.attributes.eventContext&&this.attributes.eventContext.trigger("pointLayerMouseOut",{id:this.id,event:t})},includesXY:function(t,e){if("marker"===this.attributes.styleType&&void 0!==this.attributes.style.radius&&void 0!==this.attributes.mapLayer){var i=this.attributes.mapLayer._map.latLngToContainerPoint(this.attributes.mapLayer.getLayers()[0].getLatLng()),s=Math.abs(t-i.x),a=Math.abs(e-i.y);return Math.pow(s,2)+Math.pow(a,2)<=Math.pow(this.attributes.style.radius+1,2)}return!1},setLayerGroup:function(t){this.set("layerGroup",t)},getLayerGroup:function(){return this.attributes.layerGroup},addToMap:function(){this.setActive(!0)},removeFromMap:function(){this.setActive(!1)},fadeEnabled:function(){return"raster"!==this.get("type")},setActive:function(t){if(t=void 0===t||t,this.set("active",t),void 0!==this.attributes.layerGroup){var e=this;this.getMapLayer(function(t){e.isActive()?e.attributes.layerGroup.hasLayer(t)||e.attributes.layerGroup.addLayer(t):e.attributes.layerGroup.hasLayer(t)&&e.attributes.layerGroup.removeLayer(t)})}},setMouseOver:function(t){t=void 0===t||t,this.set("mouseOver",t),this.updateStyle()},setSelected:function(t,e){t=void 0===t||t,e=void 0!==e?e:t,this.set("selected",t),this.set("anySelected",e),this.updateStyle()},setColor:function(t){this.set("columnColor",t),this.updateStyle()},getColor:function(){return this.attributes.columnColor},updateStyle:function(){if(void 0!==this.attributes.layerGroup){void 0!==this.attributes.columnColor&&e.extend(this.attributes.layerStyle,{fillColor:this.attributes.columnColor,color:this.attributes.columnColor});var t=this;this.getMapLayer(function(i){t.isSelected()?i.setStyle(e.extend({},t.attributes.layerStyle,{fillOpacity:.9,weight:3})):t.isMouseOver()?i.setStyle(e.extend({},t.attributes.layerStyle,{fillOpacity:.6,weight:1.5})):t.isAnySelected()?i.setStyle(e.extend({},t.attributes.layerStyle,{opacity:1,fillOpacity:.4,color:"#bbb",fillColor:"#eee",weight:1.2})):i.setStyle(t.attributes.layerStyle)})}},bringToFront:function(){void 0!==this.attributes.layerGroup&&this.isActive()&&this.getMapLayer(function(t){t._map&&t._map.hasLayer&&t._map.hasLayer(t)&&t.bringToFront()})},centerMap:function(){void 0!==this.attributes.layerGroup&&this.isActive()&&this.getMapLayer(function(t){t._map.panTo(t.getLayers()[0].getLatLng())})},panToViewIfNeeded:function(){if(void 0!==this.attributes.layerGroup){var t=this;this.getMapLayer(function(e){if(void 0!==e._map){var i=e._map;i&&!i.getBounds().contains(e.getLayers()[0].getLatLng())&&t.centerMap()}})}},getActiveTime:function(){return this.attributes.activeTime},getOrder:function(){return this.attributes.order},isActive:function(){return this.attributes.active},isSelected:function(){return this.attributes.selected},isMouseOver:function(){return this.attributes.mouseOver},isAnySelected:function(){return this.attributes.anySelected},setBasemap:function(t){t=void 0===t||t,this.set("basemap",t)},isBasemap:function(){return this.attributes.basemap},setLoading:function(t){t=void 0===t||t,this.set("loading",t)},isLoading:function(){return this.attributes.loading},isLoaded:function(){return void 0!==this.attributes.mapLayer&&!this.isLoading()},getBounds:function(){return this.attributes.bounds},initStyles:function(){this.attributes.layerStyle={},void 0===this.attributes.styleType&&(this.attributes.styleType="point"===this.attributes.type?"marker":this.attributes.type);var t=e.clone(this.attributes.mapConfig.layerStyles)[this.attributes.styleType];if(this.attributes.layerStyle=void 0!==t?e.clone(t):e.clone(this.attributes.mapConfig.layerStyles.default),this.attributes.layerStyle.fillColor=this.copyStyleAttribute(this.attributes.layerStyle.color,this.attributes.layerStyle.fillColor),this.attributes.layerStyle.fillOpacity=this.copyStyleAttribute(this.attributes.layerStyle.opacity,this.attributes.layerStyle.fillOpacity),void 0!==this.attributes.styleRef){var i=e.clone(this.attributes.mapConfig.refStyles[this.attributes.styleRef]);i.fillColor=this.copyStyleAttribute(i.color,i.fillColor),i.fillOpacity=this.copyStyleAttribute(i.opacity,i.fillOpacity),void 0!==i&&e.extend(this.attributes.layerStyle,e.clone(i))}void 0!==this.attributes.style&&(this.attributes.style.fillColor=this.copyStyleAttribute(this.attributes.style.color,this.attributes.style.fillColor),this.attributes.style.fillOpacity=this.copyStyleAttribute(this.attributes.style.opacity,this.attributes.style.fillOpacity),e.extend(this.attributes.layerStyle,this.attributes.style)),this.attributes.layerStyle.weight=parseFloat(this.attributes.layerStyle.weight)},copyStyleAttribute:function(t,e){return void 0!==t&&void 0===e?t:e},getLayerStyle:function(){return this.attributes.layerStyle}})});